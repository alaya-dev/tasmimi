# دليل تكامل نظام الدفع مع Moyasar

## نظرة عامة

تم تطوير نظام دفع متكامل مع Moyasar لإدارة الاشتراكات بمرونة كاملة. يتيح النظام للمدير العام إدارة أنواع الاشتراكات بحرية تامة دون الحاجة لتدخل المطور.

## الميزات الرئيسية

### 1. إدارة الاشتراكات المرنة
- **أنواع الاشتراكات**: أسبوعي، شهري، سنوي، أو مخصص
- **مدة مخصصة**: إمكانية تحديد أي عدد من الأيام
- **ميزات قابلة للتخصيص**: إضافة قائمة بالميزات المتضمنة
- **ترتيب العرض**: تحكم في ترتيب ظهور الخطط
- **خطة شعبية**: تمييز الخطة الأكثر شعبية
- **ألوان مخصصة**: تخصيص لون كل خطة

### 2. طرق الدفع المدعومة
- **البطاقات الائتمانية**: فيزا، ماستركارد، مدى
- **STC Pay**: محفظة STC Pay الرقمية
- **Apple Pay**: الدفع عبر Apple Pay

### 3. واجهة المدير
- **إضافة خطط جديدة**: إنشاء خطط اشتراك بمرونة كاملة
- **تعديل الخطط الموجودة**: تحديث الأسعار والميزات والمدة
- **إدارة الحالة**: تفعيل/إلغاء تفعيل الخطط
- **عرض الإحصائيات**: متابعة المدفوعات والاشتراكات

### 4. واجهة العميل
- **عرض الخطط**: صفحة جذابة لعرض جميع الخطط المتاحة
- **صفحة الدفع**: واجهة آمنة ومبسطة للدفع
- **إدارة الاشتراك**: عرض الاشتراك الحالي وإمكانية الإلغاء
- **تاريخ المدفوعات**: عرض جميع المدفوعات السابقة

## الإعداد والتكوين

### 1. متغيرات البيئة (.env)
```env
# Moyasar Configuration (Test Mode)
MOYASAR_PUBLISHABLE_KEY=pk_test_moyasar_key_here
MOYASAR_SECRET_KEY=sk_test_moyasar_key_here
MOYASAR_WEBHOOK_SECRET=your_webhook_secret
```

### 2. الروابط المهمة

#### للمدير:
- `/admin/subscriptions` - إدارة خطط الاشتراك

#### للعملاء:
- `/client/subscriptions` - عرض الخطط المتاحة
- `/client/subscription/manage` - إدارة الاشتراك الحالي
- `/client/payment/{subscription}` - صفحة الدفع

#### للنظام:
- `/moyasar/webhook` - استقبال إشعارات Moyasar

## كيفية الاستخدام

### للمدير العام:

1. **تسجيل الدخول** إلى لوحة الإدارة
2. **الانتقال** إلى قسم "الاشتراكات"
3. **إضافة خطة جديدة**:
   - اختيار نوع الاشتراك (أسبوعي، شهري، سنوي، أو مخصص)
   - تحديد المدة بالأيام (للنوع المخصص)
   - تحديد السعر
   - إضافة الوصف والميزات
   - تحديد ترتيب العرض
   - اختيار لون البطاقة (اختياري)
   - تحديد ما إذا كانت الخطة شعبية

4. **تعديل الخطط الموجودة**:
   - النقر على "تعديل" بجانب أي خطة
   - تحديث المعلومات المطلوبة
   - حفظ التغييرات

### للعملاء:

1. **عرض الخطط المتاحة**:
   - زيارة صفحة الاشتراكات
   - مقارنة الخطط والميزات
   - اختيار الخطة المناسبة

2. **عملية الدفع**:
   - اختيار طريقة الدفع المفضلة
   - إدخال معلومات الدفع
   - تأكيد العملية

3. **إدارة الاشتراك**:
   - عرض تفاصيل الاشتراك الحالي
   - معرفة الأيام المتبقية
   - إلغاء الاشتراك عند الحاجة
   - عرض تاريخ المدفوعات

## الأمان والحماية

### 1. تشفير البيانات
- جميع معلومات الدفع مشفرة
- استخدام HTTPS لجميع العمليات
- حماية من CSRF attacks

### 2. التحقق من الهوية
- التحقق من توقيع Moyasar للـ webhooks
- حماية الروابط الحساسة بالمصادقة
- تسجيل جميع العمليات للمراجعة

### 3. معالجة الأخطاء
- رسائل خطأ واضحة باللغة العربية
- إعادة المحاولة التلقائية للعمليات الفاشلة
- تسجيل مفصل للأخطاء

## الانتقال للإنتاج

### 1. تحديث المفاتيح
```env
# Production Keys
MOYASAR_PUBLISHABLE_KEY=pk_live_your_live_key
MOYASAR_SECRET_KEY=sk_live_your_live_key
MOYASAR_WEBHOOK_SECRET=your_production_webhook_secret
```

### 2. إعداد Webhook في Moyasar
- URL: `https://yourdomain.com/moyasar/webhook`
- الأحداث المطلوبة:
  - `payment_paid`
  - `payment_failed`
  - `payment_refunded`

### 3. اختبار النظام
- اختبار جميع طرق الدفع
- التأكد من وصول الـ webhooks
- اختبار عمليات الإلغاء والاسترداد

## الدعم والصيانة

### 1. مراقبة النظام
- متابعة حالة المدفوعات
- مراجعة سجلات الأخطاء
- مراقبة الاشتراكات المنتهية الصلاحية

### 2. النسخ الاحتياطي
- نسخ احتياطية يومية للبيانات
- حفظ سجلات المدفوعات
- أرشفة البيانات القديمة

### 3. التحديثات
- تحديث مكتبة Moyasar عند الحاجة
- مراجعة الأمان بشكل دوري
- إضافة ميزات جديدة حسب الطلب

## الخلاصة

تم تطوير نظام دفع متكامل ومرن يتيح للمدير العام إدارة الاشتراكات بحرية كاملة. النظام آمن وسهل الاستخدام ومتوافق مع معايير الدفع في المملكة العربية السعودية.

للحصول على الدعم الفني أو إضافة ميزات جديدة، يرجى التواصل مع فريق التطوير.
