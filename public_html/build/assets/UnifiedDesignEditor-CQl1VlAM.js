import{r as k,Q as q,c as a,o as l,a as m,u as T,Z as $,w as g,L as R,d as j,b as e,t as f,i as z,F as U}from"./app-BJSEvLr2.js";import{_ as H}from"./ClientLayout-BKigkkjX.js";import{U as I}from"./UnifiedDesignEditor-CkSjF2wg.js";import{_ as J}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./DropdownLink-BKuK1C9h.js";import"./useTranslations-CytgtFYN.js";import"./StableDesignEditor-qCEntoBL.js";import"./DesignElement-afgWAcdT.js";const L={class:"flex justify-between items-center flex-row-reverse"},X={class:"flex items-center flex-row-reverse"},V={class:"text-right"},K={class:"flex items-center space-x-2 space-x-reverse mt-1"},G={class:"text-sm text-gray-600"},Q={key:0,class:"text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full font-semibold"},W={key:1,class:"text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full font-semibold"},Y={key:2,class:"text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded-full font-semibold"},Z={class:"flex items-center space-x-4 space-x-reverse"},ee=["disabled"],te={key:0},se={key:1},oe={key:1,class:"flex flex-col space-y-3"},ne={class:"flex items-center space-x-3 space-x-reverse"},ae={key:0,class:"fixed top-4 right-4 z-50"},le={class:"bg-white rounded-lg shadow-xl border-l-4 border-green-500 p-4 max-w-sm"},re={class:"flex items-center"},ie={class:"mr-3"},ce={class:"text-sm font-medium text-gray-900"},de={class:"mr-auto pl-3"},ue={key:0,class:"fixed top-4 right-4 z-50"},pe={class:"bg-white rounded-lg shadow-xl border-l-4 border-red-500 p-4 max-w-sm"},me={class:"flex items-center"},ge={class:"mr-3"},fe={class:"text-sm font-medium text-gray-900"},ve={class:"mr-auto pl-3"},xe={__name:"UnifiedDesignEditor",props:{template:{type:Object,required:!0},originalTemplate:{type:Object,required:!1},mode:{type:String,required:!1},hasActiveSubscription:{type:Boolean,default:!0},templatePrice:{type:Number,default:0},canSaveAndDownload:{type:Boolean,default:!0}},setup(n){const o=n,v=k(!1);q();const x=k(!1),h=k(!1),y=k(""),D=()=>{window.location.href=route("client.templates.purchase",o.template.id)},F=async s=>{try{if(!o.canSaveAndDownload){b("للحفظ والتحميل، يجب شراء هذا القالب أو الاشتراك الشهري");return}v.value=!0,console.log("🔧 Client: Handling save for template:",o.template.id),console.log("🔧 Client: Template object:",o.template),console.log("🔧 Client: Original template:",o.originalTemplate),console.log("🔧 Client: Mode:",o.mode);let t;o.originalTemplate?(t=o.originalTemplate.id,console.log("🔧 Client: Editing client template, using original template ID:",t)):(t=o.template.id,console.log("🔧 Client: Creating from original template, using template ID:",t)),console.log("🔧 Client: Template object:",o.template),console.log("🔧 Client: Original template:",o.originalTemplate),console.log("🔧 Client: Final template_id being sent:",t);let d=document.querySelector('meta[name="csrf-token"]');if(!d)throw new Error("CSRF token not found in page meta tags");let C=d.getAttribute("content");if(!C)throw new Error("CSRF token is empty");console.log("🔧 Client: CSRF token found:",C.substring(0,10)+"...");const u={name:o.template.name||"تصميمي الجديد",template_id:t,design_data:s.designDataString,canvas_size:s.canvasSize,design_notes:s.designNotes};o.mode==="edit"&&o.template.id&&(u.client_template_id=o.template.id),console.log("🔧 Client: Request data being sent:",{name:u.name,template_id:u.template_id,client_template_id:u.client_template_id,data_size:u.design_data.length});const i=await fetch(route("client.designs.store"),{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":C,Accept:"application/json"},body:JSON.stringify(u)});if(console.log("🔍 Client: Response status:",i.status),console.log("🔍 Client: Response headers:",Object.fromEntries(i.headers.entries())),i.ok){const r=await i.json();if(console.log("✅ Client: Design saved successfully",r),r.success){const c=r.action||"saved";let p=r.message||"تم حفظ التصميم بنجاح";c==="created"?console.log("🆕 Client: New design created"):c==="updated"&&console.log("🔄 Client: Existing design updated"),_(p)}}else{if(i.status===419){console.log("🔄 Client: CSRF token expired, refreshing silently...");try{const p=await P();console.log("🔄 Client: Retrying save with fresh CSRF token...");const S=await fetch(route("client.designs.store"),{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":p,Accept:"application/json"},body:JSON.stringify(u)});if(S.ok){const w=await S.json();if(console.log("✅ Client: Save successful after token refresh:",w),w.success){const E=w.action||"saved";let B=w.message||"تم حفظ التصميم بنجاح";E==="created"?console.log("🆕 Client: New design created"):E==="updated"&&console.log("🔄 Client: Existing design updated"),_(B);return}}console.log("❌ Client: Retry failed after token refresh"),b("حدث خطأ أثناء حفظ التصميم");return}catch(p){console.error("❌ Client: Failed to refresh token:",p),b("حدث خطأ أثناء حفظ التصميم");return}}const r=await i.text();console.error("❌ Client: Raw error response:",r);let c="Failed to save design";try{c=JSON.parse(r).message||c}catch{console.error("❌ Client: Could not parse error response as JSON"),r.includes("<!DOCTYPE")?c=`خطأ في الخادم (${i.status}). يرجى المحاولة مرة أخرى.`:c=`خطأ غير متوقع (${i.status}): ${r.substring(0,100)}`}throw new Error(c)}}catch(t){console.error("❌ Client: Error saving design:",t),b("خطأ في حفظ التصميم: "+t.message)}finally{v.value=!1}},A=s=>{console.log("🔧 Client: Handling update:",s)},M=s=>{console.log("🔧 Client: Handling export:",s)},O=()=>{},N=()=>{window.history.back()},_=s=>{y.value=s,x.value=!0,setTimeout(()=>{x.value=!1},3e3)},b=s=>{y.value=s,h.value=!0,setTimeout(()=>{h.value=!1},3e3)},P=async()=>{try{console.log("🔄 Client: Refreshing CSRF token...");const s=await fetch("/csrf-token",{method:"GET",headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"}});if(s.ok){const t=await s.json();if(t.csrf_token){const d=document.querySelector('meta[name="csrf-token"]');if(d)return d.setAttribute("content",t.csrf_token),console.log("✅ Client: CSRF token refreshed successfully"),t.csrf_token}}throw new Error("Failed to refresh CSRF token")}catch(s){throw console.error("❌ Client: Error refreshing CSRF token:",s),s}};return(s,t)=>(l(),a(U,null,[m(T($),{title:"محرر التصميم"}),m(H,null,{header:g(()=>[e("div",L,[e("div",X,[e("button",{onClick:N,class:"ml-4 text-gray-600 hover:text-gray-900 transition-colors duration-200"},t[2]||(t[2]=[e("svg",{class:"w-5 h-5 rotate-180",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 19l-7-7 7-7"})],-1)])),e("div",V,[t[3]||(t[3]=e("h2",{class:"font-semibold text-xl text-gray-800 leading-tight"},"محرر التصميم",-1)),e("div",K,[e("p",G,f(n.template.name||"تصميمي"),1),n.templatePrice===0?(l(),a("span",Q," مجاني ")):n.canSaveAndDownload?(l(),a("span",W," وصول كامل ")):(l(),a("span",Y," معاينة - "+f(n.templatePrice)+" ر.س ",1))])])]),e("div",Z,[n.canSaveAndDownload?(l(),a("button",{key:0,onClick:O,disabled:v.value,class:"bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50"},[v.value?(l(),a("span",te,"جاري الحفظ...")):(l(),a("span",se,"حفظ التصميم"))],8,ee)):(l(),a("div",oe,[e("div",ne,[e("button",{onClick:D,class:"bg-orange-600 text-white px-6 py-2 rounded-lg hover:bg-orange-700 transition-colors flex items-center space-x-2 space-x-reverse"},[t[4]||(t[4]=e("i",{class:"fas fa-shopping-cart"},null,-1)),e("span",null,"شراء القالب ("+f(n.templatePrice)+" ريال)",1)]),t[6]||(t[6]=e("span",{class:"text-gray-400"},"أو",-1)),m(T(z),{href:s.route("client.subscriptions.index"),class:"bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center space-x-2 space-x-reverse"},{default:g(()=>t[5]||(t[5]=[e("i",{class:"fas fa-crown"},null,-1),e("span",null,"الاشتراك الشهري",-1)])),_:1,__:[5]},8,["href"])]),t[7]||(t[7]=e("div",{class:"text-sm text-gray-600 bg-blue-50 px-4 py-3 rounded-lg border border-blue-200"},[e("div",{class:"flex items-start space-x-2 space-x-reverse"},[e("i",{class:"fas fa-info-circle text-blue-600 mt-0.5"}),e("div",null,[e("p",{class:"font-semibold text-blue-800 mb-1"},"يمكنك الآن:"),e("ul",{class:"text-blue-700 space-y-1"},[e("li",null,"• تعديل التصميم والمعاينة"),e("li",null,"• تجربة جميع الأدوات")]),e("p",{class:"font-semibold text-blue-800 mt-2 mb-1"},"للحفظ والتحميل تحتاج:"),e("ul",{class:"text-blue-700 space-y-1"},[e("li",null,"• شراء هذا القالب، أو"),e("li",null,"• الاشتراك الشهري للوصول لجميع القوالب")])])])],-1))]))])])]),default:g(()=>[m(I,{template:n.template,context:"client",user:s.$page.props.auth.user,hasActiveSubscription:n.hasActiveSubscription,templatePrice:n.templatePrice,canSaveAndDownload:n.canSaveAndDownload,onSave:F,onUpdate:A,onExport:M},null,8,["template","user","hasActiveSubscription","templatePrice","canSaveAndDownload"]),m(R,{"enter-active-class":"transition ease-out duration-300","enter-from-class":"opacity-0 transform translate-y-2","enter-to-class":"opacity-100 transform translate-y-0","leave-active-class":"transition ease-in duration-200","leave-from-class":"opacity-100 transform translate-y-0","leave-to-class":"opacity-0 transform translate-y-2"},{default:g(()=>[x.value?(l(),a("div",ae,[e("div",le,[e("div",re,[t[9]||(t[9]=e("div",{class:"flex-shrink-0"},[e("svg",{class:"w-6 h-6 text-green-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})])],-1)),e("div",ie,[e("p",ce,f(y.value),1)]),e("div",de,[e("button",{onClick:t[0]||(t[0]=d=>x.value=!1),class:"text-gray-400 hover:text-gray-600"},t[8]||(t[8]=[e("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)]))])])])])):j("",!0)]),_:1}),m(R,{"enter-active-class":"transition ease-out duration-300","enter-from-class":"opacity-0 transform translate-y-2","enter-to-class":"opacity-100 transform translate-y-0","leave-active-class":"transition ease-in duration-200","leave-from-class":"opacity-100 transform translate-y-0","leave-to-class":"opacity-0 transform translate-y-2"},{default:g(()=>[h.value?(l(),a("div",ue,[e("div",pe,[e("div",me,[t[11]||(t[11]=e("div",{class:"flex-shrink-0"},[e("svg",{class:"w-6 h-6 text-red-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})])],-1)),e("div",ge,[e("p",fe,f(y.value),1)]),e("div",ve,[e("button",{onClick:t[1]||(t[1]=d=>h.value=!1),class:"text-gray-400 hover:text-gray-600"},t[10]||(t[10]=[e("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)]))])])])])):j("",!0)]),_:1})]),_:1})],64))}},Ee=J(xe,[["__scopeId","data-v-0fbc757a"]]);export{Ee as default};
